png(file.path(current.dir,"plots","ASPMBiomass_Spawn.png"),height=8,width=18, units="in",res=300)
ASPM_Plot<-ggplot()+
geom_point(aes(x=Year,y=Value), data=SumBioSpawn,size=1)+
geom_line(aes(x=Year,y=Value), data=SumBioSpawn,size=1)+
geom_point(aes(x=Year,y=Value), data=ASPMSumBioSpawn,size=1, shape=17)+
geom_line(aes(x=Year,y=Value), data=ASPMSumBioSpawn,size=1, linetype="dashed")+
geom_ribbon(aes(x=Year,ymin=Value-1.96*StdDev,ymax=Value+1.96*StdDev),data=SumBioSpawn,alpha=0.2)+
#   geom_ribbon(aes(x=Year,ymin=Value-1.96*StdDev,ymax=Value+1.96*StdDev),data=ASPMSumBioSpawn,alpha=0.2)+
ylab("Spawning Biomass (mt)") +
xlab("Year")+
theme(axis.text.x=element_text(size=8), axis.title.x=element_text(size=12),
axis.text.y=element_text(size=8),axis.title.y=element_text(size=12),
panel.border = element_rect(color="black",fill=NA,size=1),
panel.background = element_blank())+
scale_x_continuous(breaks=seq(startyear,endyear,5))# +
#scale_y_continuous(label = comma)
ASPM_Plot
dev.off()
summaryoutput <- SSsummarize(SSreps[c(1,5:17)])
lbf  <- summaryoutput$likelihoods_by_fleet
FleetNames <- summaryoutput$FleetNames[[1]]
sizefreqlike_component <- (grep('Survey',fleetlike_components))
if (length(sizefreqlike_component) > 0) {
for (ii in 1:length(sizefreqlike_component)) {
sizefreqlike_label <- fleetlike_components[sizefreqlike_component[ii]]
sizefreqlambda_label <-  sub('like','lambda',sizefreqlike_label)
sizefreqlambda <- summaryoutput$likelihoods_by_fleet[summaryoutput$likelihoods_by_fleet$Label == sizefreqlambda_label, 4:ncol(summaryoutput$likelihoods_by_fleet)]
sizefreqlike <- summaryoutput$likelihoods_by_fleet[summaryoutput$likelihoods_by_fleet$Label == sizefreqlike_label, 4:ncol(summaryoutput$likelihoods_by_fleet)] * sizefreqlambda
summaryoutput$likelihoods_by_fleet[summaryoutput$likelihoods_by_fleet$Label == sizefreqlike_label, names(summaryoutput$likelihoods_by_fleet)=='ALL'] <- rowSums(sizefreqlike, na.rm=T)
}
}
plotstuff <- function(){
SSplotProfile(summaryoutput,plot=T,print=F,profile.string='R0',profile.label=expression(log(italic(R)[0])),components=mainlike_components,component.labels=mainlike_components,col=c('black',blue2green2red(length(mainlike_components)-1)),legendloc='top')
for (ii in 1:length(fleetlike_components)) {
minlike_byfleet <- apply(as.matrix(lbf[(which(lbf$Label %in% fleetlike_components[ii])), colnames(lbf) %in% FleetNames]),2,min)
maxlike_byfleet <- apply(as.matrix(lbf[(which(lbf$Label %in% fleetlike_components[ii])), colnames(lbf) %in% FleetNames]),2,max)
difflike_byfleet <- maxlike_byfleet - minlike_byfleet
lambdas_byfleet <- colMeans(as.matrix(lbf[(which(lbf$Label %in% fleetlike_components[ii]))-1, colnames(lbf) %in% FleetNames]))
wantedFleets <-  which(lambdas_byfleet > 0)
ymax <- 1.3*max(difflike_byfleet[wantedFleets])
PinerPlot(summaryoutput,plot=T,print=F,profile.string='R0',component=fleetlike_components[ii],fleets=wantedFleets,col=c('black',blue2green2red(length(wantedFleets))),main=paste('Changes in',fleetlike_components_labels[ii],'by fleet'),ymax=ymax,legendloc='top', minfraction = 0.001)
}
}
printstuff <- function() {
like.table <- list()
like.table[[1]] <- SSplotProfile(summaryoutput,plot=F,print=F,profile.string='R0',components=mainlike_components,component.labels=mainlike_components)
for (ii in 1:length(fleetlike_components)) {
like.table[[ii+1]] <- PinerPlot(summaryoutput,plot=F,print=F,profile.string='R0',component=fleetlike_components[ii])
}
return(like.table)
}
if (showplot_yn) plotstuff()
if (pdf_yn) {
pdf(file=pdf.filename)
plotstuff()
dev.off()
}
if (png_yn) {
png(file=paste(png.filename,'_%d.png',sep=''))
plotstuff()
dev.off()
}
if (csv_yn) {
out <- printstuff()
write.table(out, file=csv.filename, sep=',', row.names=F)
}
summaryoutput <- SSsummarize(SSreps[[c(1,5:17)]])
SSreps <- SSgetoutput(dirvec=dirvec,getcovar=F, forecast=FALSE)[c(1,5:17)]
dirvec <- dir(pattern=ssdirpattern)
SSreps <- SSgetoutput(dirvec=dirvec,getcovar=F, forecast=FALSE)[c(1,5:17)]
# ## load the model
# base.model<-SS_output(getwd())
# ## plot the model
# SS_plots(base.model, pdf = TRUE, png = FALSE, html=FALSE)
#
setwd(paste0(current.dir,"\\R0_Prof"))
SSreps <- SSgetoutput(dirvec=dirvec,getcovar=F, forecast=FALSE)[c(1,5:17)]
summaryoutput <- SSsummarize(SSreps)
lbf  <- summaryoutput$likelihoods_by_fleet
FleetNames <- summaryoutput$FleetNames[[1]]
dirvec <- dir(pattern=ssdirpattern)
SSreps <- SSgetoutput(dirvec=dirvec,getcovar=F, forecast=FALSE)
summaryoutput <- SSsummarize(SSreps[c(1,5:17)])
lbf  <- summaryoutput$likelihoods_by_fleet
FleetNames <- summaryoutput$FleetNames[[1]]
sizefreqlike_component <- (grep('Survey',fleetlike_components))
if (length(sizefreqlike_component) > 0) {
for (ii in 1:length(sizefreqlike_component)) {
sizefreqlike_label <- fleetlike_components[sizefreqlike_component[ii]]
sizefreqlambda_label <-  sub('like','lambda',sizefreqlike_label)
sizefreqlambda <- summaryoutput$likelihoods_by_fleet[summaryoutput$likelihoods_by_fleet$Label == sizefreqlambda_label, 4:ncol(summaryoutput$likelihoods_by_fleet)]
sizefreqlike <- summaryoutput$likelihoods_by_fleet[summaryoutput$likelihoods_by_fleet$Label == sizefreqlike_label, 4:ncol(summaryoutput$likelihoods_by_fleet)] * sizefreqlambda
summaryoutput$likelihoods_by_fleet[summaryoutput$likelihoods_by_fleet$Label == sizefreqlike_label, names(summaryoutput$likelihoods_by_fleet)=='ALL'] <- rowSums(sizefreqlike, na.rm=T)
}
}
plotstuff <- function(){
SSplotProfile(summaryoutput,plot=T,print=F,profile.string='R0',profile.label=expression(log(italic(R)[0])),components=mainlike_components,component.labels=mainlike_components,col=c('black',blue2green2red(length(mainlike_components)-1)),legendloc='top')
for (ii in 1:length(fleetlike_components)) {
minlike_byfleet <- apply(as.matrix(lbf[(which(lbf$Label %in% fleetlike_components[ii])), colnames(lbf) %in% FleetNames]),2,min)
maxlike_byfleet <- apply(as.matrix(lbf[(which(lbf$Label %in% fleetlike_components[ii])), colnames(lbf) %in% FleetNames]),2,max)
difflike_byfleet <- maxlike_byfleet - minlike_byfleet
lambdas_byfleet <- colMeans(as.matrix(lbf[(which(lbf$Label %in% fleetlike_components[ii]))-1, colnames(lbf) %in% FleetNames]))
wantedFleets <-  which(lambdas_byfleet > 0)
ymax <- 1.3*max(difflike_byfleet[wantedFleets])
PinerPlot(summaryoutput,plot=T,print=F,profile.string='R0',component=fleetlike_components[ii],fleets=wantedFleets,col=c('black',blue2green2red(length(wantedFleets))),main=paste('Changes in',fleetlike_components_labels[ii],'by fleet'),ymax=ymax,legendloc='top', minfraction = 0.001)
}
}
printstuff <- function() {
like.table <- list()
like.table[[1]] <- SSplotProfile(summaryoutput,plot=F,print=F,profile.string='R0',components=mainlike_components,component.labels=mainlike_components)
for (ii in 1:length(fleetlike_components)) {
like.table[[ii+1]] <- PinerPlot(summaryoutput,plot=F,print=F,profile.string='R0',component=fleetlike_components[ii])
}
return(like.table)
}
if (showplot_yn) plotstuff()
if (pdf_yn) {
pdf(file=pdf.filename)
plotstuff()
dev.off()
}
if (png_yn) {
png(file=paste(png.filename,'_%d.png',sep=''))
plotstuff()
dev.off()
}
if (csv_yn) {
out <- printstuff()
write.table(out, file=csv.filename, sep=',', row.names=F)
}
base.model
base.dir<-"C://users//michelle.sculley//documents//2023 SWO ASSESS"
model.list<-c("01_Divide F9 size data",
"02_Drop S4 and S8",
"03_both 1 and 2",
"04_change Lmin",
"05_change settlement month",
"06_increase CV Lmin",
"07_lognormal selec",
"08_2 4 and 7",
"09_3 and 7",
"10_3 4 7 and 6",
"11_drop F20 decrease Amin",
"12_mirrow F9",
"13_mirrorF9 decrease Amin",
"14_mirrorF9 decrease Amin Fix eqcat")
#current.dir<-paste0(base.dir,"//SA Meeting Runs//",model.list[4])
#current.dir<-paste0(base.dir, "//ModelDev//Current Best")#//F9 Cubic Spline")
#current.dir<-paste0(base.dir,"//ModelDev//NoSex//TWN block//JPN F1 block//DW Size Comp//Split F9 size")
setwd(base.dir)
### Run all
# for ( i in 1:length(model.list)){
#   current.dir<-paste0(base.dir,"//SA Meeting Runs//",model.list[i])
#
#   base.model<-SS_output(current.dir)#, printstats = FALSE, verbose=FALSE)
#
#
#
# SS_plots(base.model, html = FALSE, png = FALSE, pdf=TRUE, catchasnumbers = TRUE)
# }
#### RUn just one
current.dir<-paste0(base.dir,"//SA Meeting Runs//",model.list[7])
plotdir<-paste0(current.dir,"//plots")
base.model<-SS_output(current.dir, printstats = FALSE, verbose=FALSE)
library(r4ss)
# ## load the model
# base.model<-SS_output(getwd())
# ## plot the model
# SS_plots(base.model, pdf = TRUE, png = FALSE, html=FALSE)
#
setwd(paste0(current.dir,"\\R0_Prof"))
rm(list=ls())
library('foreach')
#library('doMC') # Comment out for windows
library('doSNOW') # Uncomment for Windows
parm.min <- 6.0
parm.max <-8.0
parm.step <- 0.1
parmstr.parfile <- '# SR_parm\\[1]:' # Note that you need to add double backslash for escape character for grep
parfile <- 'ss.par'
ssdir.orig <- 'orig'
numcpus <- 8
#runss.str <- './SS324ab.bin -nohess -nox' # Comment out for windows
runss.str <- 'ss.exe -nohess -nox' # Uncomment for Windows
origwd <- getwd()
parm.vec <- seq(parm.min, parm.max, parm.step)
numdir <- length(parm.vec)
for (ii in 1:numdir) {
dir.name <- paste(sprintf('%02d',ii),sprintf('%.2f',parm.vec[ii]),sep='_')
#	system(paste('cp -r', ssdir.orig, dir.name, sep=' ')) # Comment out for windows
system(paste('xcopy ', ssdir.orig, ' ', dir.name, '\\* ', '/E', sep='')) # Uncomment for Windows
parfile.infile <- paste(dir.name,'/',parfile, sep='')
conn <- file(parfile.infile, open='r')
parfile.intxt <- readLines(conn)
close(conn)
parfile.outtxt <- parfile.intxt
wantedline <- grep(parmstr.parfile,parfile.intxt)
parfile.outtxt[wantedline+1] <-  parm.vec[ii]
conn <- file(parfile.infile, open='w')
writeLines(parfile.outtxt, conn)
close(conn)
}
#registerDoMC(numcpus) # Comment out for windows
cl<-makeCluster(numcpus) # Uncomment for Windows
registerDoSNOW(cl) # Uncomment for Windows
foreach(ii=1:numdir) %dopar% {
dir.name <- paste(sprintf('%02d',ii),sprintf('%.2f',parm.vec[ii]),sep='_')
setwd(paste(origwd,'/',dir.name,sep=''))
print(paste(origwd,'/',dir.name,sep=''))
system(runss.str)
setwd(origwd)
}
stopCluster(cl) # Uncomment for Windows
setwd(origwd)
for (ii in 1:numdir) {
dir.name <- paste(sprintf('%02d',ii),sprintf('%.2f',parm.vec[ii]),sep='_')
#	system(paste('cp -r', ssdir.orig, dir.name, sep=' ')) # Comment out for windows
system(paste('xcopy ', ssdir.orig, ' ', dir.name, '\\* ', '/E', sep='')) # Uncomment for Windows
parfile.infile <- paste(dir.name,'/',parfile, sep='')
conn <- file(parfile.infile, open='r')
parfile.intxt <- readLines(conn)
close(conn)
parfile.outtxt <- parfile.intxt
wantedline <- grep(parmstr.parfile,parfile.intxt)
parfile.outtxt[wantedline+1] <-  parm.vec[ii]
conn <- file(parfile.infile, open='w')
writeLines(parfile.outtxt, conn)
close(conn)
}
#registerDoMC(numcpus) # Comment out for windows
cl<-makeCluster(numcpus) # Uncomment for Windows
registerDoSNOW(cl) # Uncomment for Windows
foreach(ii=1:numdir) %dopar% {
dir.name <- paste(sprintf('%02d',ii),sprintf('%.2f',parm.vec[ii]),sep='_')
setwd(paste(origwd,'/',dir.name,sep=''))
print(paste(origwd,'/',dir.name,sep=''))
system(runss.str)
setwd(origwd)
}
stopCluster(cl) # Uncomment for Windows
setwd(origwd)
showplot_yn <- F
pdf_yn <- T
png_yn <- T
csv_yn <- T
mainfolder <- './'
pdf.filename <- paste('r0profile',format(Sys.time(), "%Y%m%d_%H%M.pdf"),sep='_')
png.filename <- paste('r0profile',format(Sys.time(), "%Y%m%d_%H%M"),sep='_')
csv.filename <- paste('r0profile',format(Sys.time(), "%Y%m%d_%H%M.csv"),sep='_')
mainlike_components <- c('TOTAL','Survey','Length_comp','Recruitment','Catch','Equil_catch')
#mainlike_components <- c('TOTAL','Survey','SizeFreq','Recruitment','Catch')
#fleetlike_components <- c('Surv_like','Length_like','SizeFreq_like:_1','SizeFreq_like:_2','SizeFreq_like:_3','Age_like')
#fleetlike_components_labels <- c('survey likelihood','2 cm bin likelihood', '7 cm bin likelihood','2 cm bin - Age-0 likelihood', '7 cm bin - Age-0 likelihood','Cond-Age-at-len likelihood')
fleetlike_components <- c('Surv_like','Catch_like','Length_like')
fleetlike_components_labels <- c('index likelihood','Catch Likelihood','Length Composition Likelihood')
ssdirpattern <- '^[0-9]{2}'
profile.string <- 'R0'
profile.label <- expression(log(italic(R)[0]))
setwd(mainfolder)
dirvec <- dir(pattern=ssdirpattern)
SSreps <- SSgetoutput(dirvec=dirvec,getcovar=F, forecast=FALSE)
SSreps <- SSgetoutput(dirvec=dirvec,getcovar=F, forecast=FALSE)
### Functions ####
# from run_r0
parm.min <- 6.2
parm.max <-8.0
parm.step <- 0.1
parm.vec <- seq(parm.min, parm.max, parm.step)
numdir <- length(parm.vec)
dirvec <- dir(pattern=ssdirpattern)
SSreps <- SSgetoutput(dirvec=dirvec[c(1,4:22)],getcovar=F, forecast=FALSE)
summaryoutput <- SSsummarize(SSreps)
summaryoutput$likelihoods[1,]
parm.min <- 6.2
parm.max <-7.8
parm.step <- 0.1
parmstr.parfile <- '# SR_parm\\[1]:' # Note that you need to add double backslash for escape character for grep
parfile <- 'ss.par'
ssdir.orig <- 'orig'
numcpus <- 8
#runss.str <- './SS324ab.bin -nohess -nox' # Comment out for windows
runss.str <- 'ss.exe -nohess -nox' # Uncomment for Windows
origwd <- getwd()
parm.vec <- seq(parm.min, parm.max, parm.step)
numdir <- length(parm.vec)
for (ii in 1:numdir) {
dir.name <- paste(sprintf('%02d',ii),sprintf('%.2f',parm.vec[ii]),sep='_')
#	system(paste('cp -r', ssdir.orig, dir.name, sep=' ')) # Comment out for windows
system(paste('xcopy ', ssdir.orig, ' ', dir.name, '\\* ', '/E', sep='')) # Uncomment for Windows
parfile.infile <- paste(dir.name,'/',parfile, sep='')
conn <- file(parfile.infile, open='r')
parfile.intxt <- readLines(conn)
close(conn)
parfile.outtxt <- parfile.intxt
wantedline <- grep(parmstr.parfile,parfile.intxt)
parfile.outtxt[wantedline+1] <-  parm.vec[ii]
conn <- file(parfile.infile, open='w')
writeLines(parfile.outtxt, conn)
close(conn)
}
#registerDoMC(numcpus) # Comment out for windo
cl<-makeCluster(numcpus) # Uncomment for Windows
registerDoSNOW(cl) # Uncomment for Windows
foreach(ii=1:numdir) %dopar% {
dir.name <- paste(sprintf('%02d',ii),sprintf('%.2f',parm.vec[ii]),sep='_')
setwd(paste(origwd,'/',dir.name,sep=''))
print(paste(origwd,'/',dir.name,sep=''))
system(runss.str)
setwd(origwd)
}
stopCluster(cl) # Uncomment for Windows
setwd(origwd)
showplot_yn <- F
pdf_yn <- T
png_yn <- T
csv_yn <- T
mainfolder <- './'
pdf.filename <- paste('r0profile',format(Sys.time(), "%Y%m%d_%H%M.pdf"),sep='_')
png.filename <- paste('r0profile',format(Sys.time(), "%Y%m%d_%H%M"),sep='_')
csv.filename <- paste('r0profile',format(Sys.time(), "%Y%m%d_%H%M.csv"),sep='_')
mainlike_components <- c('TOTAL','Survey','Length_comp','Recruitment','Catch','Equil_catch')
#mainlike_components <- c('TOTAL','Survey','SizeFreq','Recruitment','Catch')
#fleetlike_components <- c('Surv_like','Length_like','SizeFreq_like:_1','SizeFreq_like:_2','SizeFreq_like:_3','Age_like')
#fleetlike_components_labels <- c('survey likelihood','2 cm bin likelihood', '7 cm bin likelihood','2 cm bin - Age-0 likelihood', '7 cm bin - Age-0 likelihood','Cond-Age-at-len likelihood')
fleetlike_components <- c('Surv_like','Catch_like','Length_like')
fleetlike_components_labels <- c('index likelihood','Catch Likelihood','Length Composition Likelihood')
ssdirpattern <- '^[0-9]{2}'
profile.string <- 'R0'
profile.label <- expression(log(italic(R)[0]))
setwd(mainfolder)
dirvec <- dir(pattern=ssdirpattern)
SSreps <- SSgetoutput(dirvec=dirvec[c(1,4:22)],getcovar=F, forecast=FALSE)
summaryoutput <- SSsummarize(SSreps)
SSreps <- SSgetoutput(dirvec=dirvec,getcovar=F, forecast=FALSE)
summaryoutput <- SSsummarize(SSreps)
lbf  <- summaryoutput$likelihoods_by_fleet
FleetNames <- summaryoutput$FleetNames[[1]]
sizefreqlike_component <- (grep('Survey',fleetlike_components))
if (length(sizefreqlike_component) > 0) {
for (ii in 1:length(sizefreqlike_component)) {
sizefreqlike_label <- fleetlike_components[sizefreqlike_component[ii]]
sizefreqlambda_label <-  sub('like','lambda',sizefreqlike_label)
sizefreqlambda <- summaryoutput$likelihoods_by_fleet[summaryoutput$likelihoods_by_fleet$Label == sizefreqlambda_label, 4:ncol(summaryoutput$likelihoods_by_fleet)]
sizefreqlike <- summaryoutput$likelihoods_by_fleet[summaryoutput$likelihoods_by_fleet$Label == sizefreqlike_label, 4:ncol(summaryoutput$likelihoods_by_fleet)] * sizefreqlambda
summaryoutput$likelihoods_by_fleet[summaryoutput$likelihoods_by_fleet$Label == sizefreqlike_label, names(summaryoutput$likelihoods_by_fleet)=='ALL'] <- rowSums(sizefreqlike, na.rm=T)
}
}
plotstuff <- function(){
SSplotProfile(summaryoutput,plot=T,print=F,profile.string='R0',profile.label=expression(log(italic(R)[0])),components=mainlike_components,component.labels=mainlike_components,col=c('black',blue2green2red(length(mainlike_components)-1)),legendloc='top')
for (ii in 1:length(fleetlike_components)) {
minlike_byfleet <- apply(as.matrix(lbf[(which(lbf$Label %in% fleetlike_components[ii])), colnames(lbf) %in% FleetNames]),2,min)
maxlike_byfleet <- apply(as.matrix(lbf[(which(lbf$Label %in% fleetlike_components[ii])), colnames(lbf) %in% FleetNames]),2,max)
difflike_byfleet <- maxlike_byfleet - minlike_byfleet
lambdas_byfleet <- colMeans(as.matrix(lbf[(which(lbf$Label %in% fleetlike_components[ii]))-1, colnames(lbf) %in% FleetNames]))
wantedFleets <-  which(lambdas_byfleet > 0)
ymax <- 1.3*max(difflike_byfleet[wantedFleets])
PinerPlot(summaryoutput,plot=T,print=F,profile.string='R0',component=fleetlike_components[ii],fleets=wantedFleets,col=c('black',blue2green2red(length(wantedFleets))),main=paste('Changes in',fleetlike_components_labels[ii],'by fleet'),ymax=ymax,legendloc='top', minfraction = 0.001)
}
}
printstuff <- function() {
like.table <- list()
like.table[[1]] <- SSplotProfile(summaryoutput,plot=F,print=F,profile.string='R0',components=mainlike_components,component.labels=mainlike_components)
for (ii in 1:length(fleetlike_components)) {
like.table[[ii+1]] <- PinerPlot(summaryoutput,plot=F,print=F,profile.string='R0',component=fleetlike_components[ii])
}
return(like.table)
}
if (showplot_yn) plotstuff()
if (pdf_yn) {
pdf(file=pdf.filename)
plotstuff()
dev.off()
}
if (png_yn) {
png(file=paste(png.filename,'_%d.png',sep=''))
plotstuff()
dev.off()
}
if (csv_yn) {
out <- printstuff()
write.table(out, file=csv.filename, sep=',', row.names=F)
}
SSreps <- SSgetoutput(dirvec=dirvec[c(1,3:18)],getcovar=F, forecast=FALSE)
summaryoutput <- SSsummarize(SSreps)
lbf  <- summaryoutput$likelihoods_by_fleet
FleetNames <- summaryoutput$FleetNames[[1]]
sizefreqlike_component <- (grep('Survey',fleetlike_components))
if (length(sizefreqlike_component) > 0) {
for (ii in 1:length(sizefreqlike_component)) {
sizefreqlike_label <- fleetlike_components[sizefreqlike_component[ii]]
sizefreqlambda_label <-  sub('like','lambda',sizefreqlike_label)
sizefreqlambda <- summaryoutput$likelihoods_by_fleet[summaryoutput$likelihoods_by_fleet$Label == sizefreqlambda_label, 4:ncol(summaryoutput$likelihoods_by_fleet)]
sizefreqlike <- summaryoutput$likelihoods_by_fleet[summaryoutput$likelihoods_by_fleet$Label == sizefreqlike_label, 4:ncol(summaryoutput$likelihoods_by_fleet)] * sizefreqlambda
summaryoutput$likelihoods_by_fleet[summaryoutput$likelihoods_by_fleet$Label == sizefreqlike_label, names(summaryoutput$likelihoods_by_fleet)=='ALL'] <- rowSums(sizefreqlike, na.rm=T)
}
}
plotstuff <- function(){
SSplotProfile(summaryoutput,plot=T,print=F,profile.string='R0',profile.label=expression(log(italic(R)[0])),components=mainlike_components,component.labels=mainlike_components,col=c('black',blue2green2red(length(mainlike_components)-1)),legendloc='top')
for (ii in 1:length(fleetlike_components)) {
minlike_byfleet <- apply(as.matrix(lbf[(which(lbf$Label %in% fleetlike_components[ii])), colnames(lbf) %in% FleetNames]),2,min)
maxlike_byfleet <- apply(as.matrix(lbf[(which(lbf$Label %in% fleetlike_components[ii])), colnames(lbf) %in% FleetNames]),2,max)
difflike_byfleet <- maxlike_byfleet - minlike_byfleet
lambdas_byfleet <- colMeans(as.matrix(lbf[(which(lbf$Label %in% fleetlike_components[ii]))-1, colnames(lbf) %in% FleetNames]))
wantedFleets <-  which(lambdas_byfleet > 0)
ymax <- 1.3*max(difflike_byfleet[wantedFleets])
PinerPlot(summaryoutput,plot=T,print=F,profile.string='R0',component=fleetlike_components[ii],fleets=wantedFleets,col=c('black',blue2green2red(length(wantedFleets))),main=paste('Changes in',fleetlike_components_labels[ii],'by fleet'),ymax=ymax,legendloc='top', minfraction = 0.001)
}
}
printstuff <- function() {
like.table <- list()
like.table[[1]] <- SSplotProfile(summaryoutput,plot=F,print=F,profile.string='R0',components=mainlike_components,component.labels=mainlike_components)
for (ii in 1:length(fleetlike_components)) {
like.table[[ii+1]] <- PinerPlot(summaryoutput,plot=F,print=F,profile.string='R0',component=fleetlike_components[ii])
}
return(like.table)
}
if (showplot_yn) plotstuff()
if (pdf_yn) {
pdf(file=pdf.filename)
plotstuff()
dev.off()
}
if (png_yn) {
png(file=paste(png.filename,'_%d.png',sep=''))
plotstuff()
dev.off()
}
if (csv_yn) {
out <- printstuff()
write.table(out, file=csv.filename, sep=',', row.names=F)
}
setwd(base.dir)
### Run all
# for ( i in 1:length(model.list)){
#   current.dir<-paste0(base.dir,"//SA Meeting Runs//",model.list[i])
#
#   base.model<-SS_output(current.dir)#, printstats = FALSE, verbose=FALSE)
#
#
#
# SS_plots(base.model, html = FALSE, png = FALSE, pdf=TRUE, catchasnumbers = TRUE)
# }
#### RUn just one
current.dir<-paste0(base.dir,"//SA Meeting Runs//",model.list[7])
plotdir<-paste0(current.dir,"//plots")
base.model<-SS_output(current.dir, printstats = FALSE, verbose=FALSE)
startyear = 1975
endyear = 2021
rnames <- base.model$derived_quants$Label
base.dir<-"C://users//michelle.sculley//documents//2023 SWO ASSESS"
model.list<-c("01_Divide F9 size data",
"02_Drop S4 and S8",
"03_both 1 and 2",
"04_change Lmin",
"05_change settlement month",
"06_increase CV Lmin",
"07_lognormal selec",
"08_2 4 and 7",
"09_3 and 7",
"10_3 4 7 and 6",
"11_drop F20 decrease Amin",
"12_mirrow F9",
"13_mirrorF9 decrease Amin",
"14_mirrorF9 decrease Amin Fix eqcat")
#current.dir<-paste0(base.dir, "//ModelDev//Current Best")#//F9 Cubic Spline")
#current.dir<-paste0(base.dir,"//ModelDev//NoSex//TWN block//JPN F1 block//DW Size Comp//Split F9 size")
setwd(base.dir)
#### RUn just one
current.dir<-paste0(base.dir,"//SA Meeting Runs//",model.list[7])
plotdir<-paste0(current.dir,"//plots")
base.model<-SS_output(current.dir, printstats = FALSE, verbose=FALSE)
startyear = 1975
endyear = 2021
rnames <- base.model$derived_quants$Label
source("~/2023 SWO ASSESS/Rscripts/002_SummaryFigs.R", echo=TRUE)
source("~/2023 SWO ASSESS/Rscripts/005_DiagnosticPlots.R", echo=TRUE)
#SS_plots(ASPM)
png(file.path(current.dir,"plots","ASPMBiomass_Spawn.png"),height=8,width=18, units="in",res=300)
ASPM_Plot<-ggplot()+
geom_point(aes(x=Year,y=Value), data=SumBioSpawn,size=1)+
geom_line(aes(x=Year,y=Value), data=SumBioSpawn,size=1)+
geom_point(aes(x=Year,y=Value), data=ASPMSumBioSpawn,size=1, shape=17)+
geom_line(aes(x=Year,y=Value), data=ASPMSumBioSpawn,size=1, linetype="dashed")+
geom_ribbon(aes(x=Year,ymin=Value-1.96*StdDev,ymax=Value+1.96*StdDev),data=SumBioSpawn,alpha=0.2)+
geom_ribbon(aes(x=Year,ymin=Value-1.96*StdDev,ymax=Value+1.96*StdDev),data=ASPMSumBioSpawn,alpha=0.2)+
ylab("Spawning Biomass (mt)") +
xlab("Year")+
theme(axis.text.x=element_text(size=8), axis.title.x=element_text(size=12),
axis.text.y=element_text(size=8),axis.title.y=element_text(size=12),
panel.border = element_rect(color="black",fill=NA,size=1),
panel.background = element_blank())+
scale_x_continuous(breaks=seq(startyear,endyear,5))# +
#scale_y_continuous(label = comma)
ASPM_Plot
dev.off()
current.dir
ASPM_Plot
View(ASPM_Plot)
# ##CPUE Runs test
#
#   png(paste0(plotdir,"//CPUERunsTest.png"),height=8,width=8, units="in",res=200)
#   sspar(mfrow=c(4,2),plot.cex = 0.8)
SSplotRunstest(base.model,subplots="cpue",add=T,cex.main = 0.8) # use add=T to maintain plot set up
#   dev.off()
# # # Add Joint Residual plot and use ploting option
# # # SSplotJABBAres(base.model,subplots="cpue",add=T,legendcex = 0.5,ylimAdj = 2)
# # #
# #
# # ## Size comp runs test
#   png(paste0(plotdir,"//LengthRunsTest.png"),height=8,width=8, units="in",res=200)
#   sspar(mfrow=c(4,2),plot.cex = 0.8)
SSplotRunstest(base.model,subplots="len",add=T,cex.main = 0.8) # use add=T to maintain plot set up
